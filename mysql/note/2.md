## 事务

#### 概念

事务由单独单元的一个或多个SQL语句组成，在这个单元中，每个MySQL语句是相互依赖的。而整个单独单元作为一个不可分割的整体，如果单元中某条SQL语句一旦执行失败或产生错误，整个单元将会回滚。所有受到影响的数据将返回到事物开始以前的状态；如果单元中的所有SQL语句均执行成功，则事物被顺利执行。


#### 为什么需要事务

当需要对数据表执行一系列多个操作的情况下，为了防止这些操作中的部分操作执行成功而另一些操作执行失败，从而导致数据不正确，我们就需要使用事务了。

例如有数据表团队和团员两张表，团员表每增加一个团员时，团队表相应团号下的总人数就需要同时增加一人，这样我们就需要分别执行追加和更新两样操作。只有两样操作都同时执行成功才能确保数据记录处在正确的状态。

现实的情况是，由于分开操作因种种原因很可能会发生第一个操作执行成功而第二个操作失败的状态，如果使用事务就就可以在系列操作不能全部成功的情况下将已经执行的操作回滚，从而防止中间状态的发生所导致的数据不正确。


## ACID

InnoDB存储引擎中的事务完全符合ACID的特性。ACID是如下：

#### 原子性 (atomicity)

原子性是指一个事务是一个不可分割的工作单位，事务中包括的诸操作要么都做，要么都不做。只有使事务中所有的数据库操作执行都成功，才算整个事务成功。只要有一个sql语句执行失败，那么在这个事务中已经执行的sql语句都必须撤销，数据库状态应该退回到执行事务前的状态。


#### 一致性(consistency)

事务必须是使数据库从一个一致性状态变到另一个一致性状态。一致性与原子性是密切相关的。在事务开始之前和结束之后，数据库的完整性约束没有被破坏。


#### 隔离性 (isolation)

 一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰，这些通过锁来实现。

#### 持久性(durability) 

持续性也称永久性（permanence），指一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。接下来的其他操作或故障（比如说宕机等）不应该对其有任何影响。



## 事务的用法

```mysql
--开启事务
start transaction
--执行sql操作(普通sql操作)
--提交/回滚
commit/rollback
```


看一个例子：我(张三)去银行给朋友汇款，我卡上5000元，朋友（李四）卡上5000元。我去银行汇款，给银行柜员1000，让他打给我朋友，但是必须在我签字完成，这个汇款才得到我的承认，在签字的那一刻之前，其实我的朋友已经收到钱了，此时他把钱立即去了出来，而此时我却后悔了，不打算会给我朋友了，此时我还是5000， 而我朋友确实6000，所以我们需要事物的隔离性，在没完成整个过程之前，事务是隔离的，别人是看不见的。

```mysql
CREATE TABLE account(
name CHAR(4) NOT NULL,
money INT UNSINGED NOT NULL
);

INSERT account VALUES('张三','5000'),VALUE('李四','5000');
/*
+--------+-------+
| name   | money |
+--------+-------+
| 张三   |  5000 |
| 李四   |  5000 |
+--------+-------+
*/
--汇给朋友
UPDATE account SET money = money -1000 WHERE name = '张三';
UPDATE account SET money = money +1000 WHERE name = '李四';

--此时，我们可以打开另一个mysql的客户端，当做为我朋友的ATM
SELECT * FROM account;
/*
+--------+-------+
| name   | money |
+--------+-------+
| 张三   |  4000 |
| 李四   |  6000 |
+--------+-------+
*/

--此时，在我们还没确定之前，这个钱就已经扣掉了。我朋友就得到1000，
--当我此时取消汇款，而朋友却在此时把钱取出来了，此时银行就亏了。

--所以，我们需要事务，在一件事没完成之前，都处于一个隔离的状态下，其他任何都不能
--查找到这个状态。


--此时，我们需要开启一个事物

START TRANSACTION;
UPDATE account SET money = money -1000 WHERE name = '张三';
UPDATE account SET money = money +1000 WHERE name = '李四';

--此时，就算你开启另一个mysql客户端，查找记录，结果什么也没发生改变。
--提交，提交后，这个事务就算完成了，你再在另一个mysql客户端查找，结界此时就发生了改变。
COMMIT;

--什么事原子性呢？假如我只有5000，我却汇给我朋友6000，肯定不行，那只能回到上一个状态了，
--即全部语句成功，才能进入下一个状态，只要一个语句错误，只能回到上一个状态。

START TRANSACTION;
UPDATE account SET money = money -6000 WHERE name = '张三';
--此时，直接报错。我们就需要回滚到上一个状态
ROLLBACK;
```



## 参考文章

[为什么要用mysql事务](https://zhidao.baidu.com/question/1672393040258552547.html)
[MySQL 事务的学习整理](http://blog.csdn.net/mchdba/article/details/12242685)
